#!/bin/bash

# Pfad zur newt-Binary
NEWTPATH="/usr/local/bin/newt"

# Funktion, um die installierte Version auszulesen
get_installed_version() {
  if [ -x "$NEWTPATH" ]; then
    version=$($NEWTPATH -version 2>&1 | grep -oP 'version \K[0-9]+\.[0-9]+\.[0-9]+')
    echo "$version"
  else
    echo "none"
  fi
}

# Funktion, um die neueste Version von GitHub zu holen
get_latest_version() {
  curl -s "https://api.github.com/repos/fosrl/newt/releases/latest" | grep -oP '"tag_name": "\K(.*)(?=")'
}

# Installationsfunktion
install_newt() {
  latest=$1
  url="https://github.com/fosrl/newt/releases/download/$latest/newt-linux-amd64"
  echo "Lade newt $latest herunter..."
  curl -L -o /tmp/newt "$url"
  if [ $? -eq 0 ]; then
    echo "Installiere newt nach $NEWTPATH"
    sudo mv /tmp/newt "$NEWTPATH"
    sudo chmod +x "$NEWTPATH"
    echo "Update erfolgreich."
  else
    echo "Download fehlgeschlagen."
    exit 1
  fi
}

installed_version=$(get_installed_version)
latest_version=$(get_latest_version)

echo "Installierte Version: $installed_version"
echo "Neueste Version: $latest_version"

if [ "$installed_version" = "none" ]; then
  echo "newt ist nicht installiert. Installation wird gestartet."
  install_newt "$latest_version"
elif [ "$installed_version" != "$latest_version" ]; then
  echo "Es gibt ein Update. Aktualisiere newt auf Version $latest_version."
  install_newt "$latest_version"
else
  echo "newt ist bereits auf dem neuesten Stand."
fi
