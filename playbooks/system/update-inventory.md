# Tailscale Inventory Update

This playbook (`update-inventory.yaml`) updates the dynamic inventory by fetching current host information from the Tailscale network and maintaining synchronized host data.

## Features

- Fetches current host list from Tailscale network
- Updates dynamic inventory with current IP addresses and hostnames
- Synchronizes host status and connectivity information
- Maintains group memberships based on Tailscale tags
- Removes stale or disconnected hosts from inventory
- Updates host variables with current network information

## Requirements

- Tailscale network access
- 1Password CLI for secret management
- Tailscale CLI installed on control host
- Network connectivity to Tailscale coordination server
- Appropriate permissions to query Tailscale network

## Variables

### Authentication
- Tailscale authentication is handled via existing login or auth keys from 1Password

### Configuration Options
- `inventory_file`: Path to inventory file to update (default: `inventories/tailscale.py`)
- `remove_offline_hosts`: Remove hosts that are offline (True/False, default: False)
- `update_host_vars`: Update individual host variables (True/False, default: True)
- `sync_groups`: Synchronize groups based on Tailscale tags (True/False, default: True)

### Filtering Options
- `include_tags`: Only include hosts with specific Tailscale tags
- `exclude_tags`: Exclude hosts with specific Tailscale tags
- `include_users`: Only include hosts owned by specific users
- `exclude_offline_duration`: Exclude hosts offline longer than specified duration

## Usage

### Basic Usage

```bash
ansible-playbook playbooks/system/update-inventory.yaml
```

### Update Specific Inventory

```bash
ansible-playbook playbooks/system/update-inventory.yaml \
  -e "inventory_file=inventories/production.py"
```

### Filter by Tags

```bash
ansible-playbook playbooks/system/update-inventory.yaml \
  -e "include_tags=server,production" \
  -e "exclude_tags=temporary"
```

### Remove Offline Hosts

```bash
ansible-playbook playbooks/system/update-inventory.yaml \
  -e "remove_offline_hosts=true" \
  -e "exclude_offline_duration=7d"
```

## Inventory Structure

The updated inventory will contain:

### Host Information
- **Hostname**: Tailscale hostname
- **IP Addresses**: Both Tailscale IP and public IP (if available)
- **Status**: Online/offline status and last seen timestamp
- **Operating System**: Detected OS and version information
- **Tags**: Applied Tailscale tags for grouping

### Group Assignments
Hosts are automatically grouped based on:
- **Tailscale tags** (e.g., `server`, `desktop`, `mobile`)
- **Operating system** (e.g., `linux`, `windows`, `darwin`)
- **Status** (e.g., `online`, `offline`)
- **Owner** (e.g., user-specific groups)

### Example Inventory Output

```python
#!/usr/bin/env python3
# Generated by update-inventory.yaml on 2024-01-15

INVENTORY = {
    'all': {
        'hosts': [
            'web-server-01',
            'db-server-01', 
            'desktop-workstation'
        ]
    },
    'servers': {
        'hosts': ['web-server-01', 'db-server-01'],
        'vars': {
            'ansible_user': 'root',
            'ansible_ssh_common_args': '-o StrictHostKeyChecking=no'
        }
    },
    'linux': {
        'hosts': ['web-server-01', 'db-server-01'],
    },
    'online': {
        'hosts': ['web-server-01', 'desktop-workstation']
    },
    '_meta': {
        'hostvars': {
            'web-server-01': {
                'ansible_host': '100.64.0.10',
                'tailscale_hostname': 'web-server-01',
                'tailscale_ip': '100.64.0.10',
                'public_ip': '203.0.113.10',
                'os': 'linux',
                'last_seen': '2024-01-15T10:30:00Z',
                'tags': ['server', 'web', 'production']
            }
        }
    }
}
```

## Secrets from 1Password

- **Tailscale API Key**: For programmatic access to Tailscale network data
- **Auth Tokens**: For accessing Tailscale coordination server

## Tasks Performed

1. **Authentication Check**
   - Verifies Tailscale CLI is available and authenticated
   - Retrieves API credentials from 1Password if needed

2. **Network Discovery**
   - Queries Tailscale network for all registered devices
   - Fetches current status and connectivity information
   - Retrieves IP addresses and hostname mappings

3. **Host Classification**
   - Categorizes hosts based on tags and attributes
   - Determines group memberships
   - Identifies host roles and functions

4. **Inventory Generation**
   - Generates updated inventory structure
   - Creates dynamic groups based on discovered attributes
   - Updates host variables with current information

5. **File Management**
   - Backs up existing inventory file
   - Writes new inventory with current data
   - Sets appropriate file permissions

6. **Validation**
   - Validates generated inventory syntax
   - Performs connectivity tests to updated hosts
   - Reports any issues or inconsistencies

## Group Assignment Logic

Hosts are assigned to groups based on these criteria:

### Tag-Based Groups
- Each Tailscale tag becomes a group (e.g., `server`, `desktop`, `mobile`)
- Multiple tags result in multiple group memberships

### OS-Based Groups  
- `linux`: All Linux-based systems
- `windows`: Windows systems
- `darwin`: macOS systems
- `android`: Android devices
- `ios`: iOS devices

### Status Groups
- `online`: Currently connected hosts
- `offline`: Disconnected hosts (if not excluded)
- `recently_seen`: Hosts seen within last 24 hours

### Custom Groups
- `managed`: Hosts with management tags
- `unmanaged`: Hosts without management tags
- `servers`: Hosts tagged as servers
- `workstations`: Desktop/laptop hosts

## Host Variables

Each host receives these variables:

```yaml
ansible_host: "100.64.0.10"           # Tailscale IP for connection
tailscale_hostname: "web-server-01"    # Tailscale hostname
tailscale_ip: "100.64.0.10"           # Tailscale network IP
public_ip: "203.0.113.10"             # Public IP (if available)
os: "linux"                           # Operating system
os_version: "Ubuntu 22.04"            # OS version
last_seen: "2024-01-15T10:30:00Z"     # Last connection timestamp
uptime: "15d 4h 23m"                  # System uptime
tags: ["server", "web", "production"] # Applied Tailscale tags
owner: "admin@example.com"            # Device owner
```

## Scheduling

For regular inventory updates, consider setting up a cron job:

```bash
# Update inventory every hour
0 * * * * cd /path/to/ansible && ansible-playbook playbooks/system/update-inventory.yaml --quiet
```

Or use Ansible's built-in scheduling:

```yaml
# In a separate playbook or role
- name: Schedule inventory updates
  cron:
    name: "Update Tailscale inventory"
    minute: "0"
    job: "cd {{ ansible_repo_path }} && ansible-playbook playbooks/system/update-inventory.yaml --quiet"
```

## Integration with Other Tools

### Ansible Tower/AWX
Configure as a project sync or inventory script for automatic updates.

### CI/CD Pipelines
Include in deployment pipelines to ensure current inventory:

```yaml
# Example GitLab CI job
update_inventory:
  script:
    - ansible-playbook playbooks/system/update-inventory.yaml
  only:
    - schedules
```

### Monitoring Integration
Monitor inventory changes and alert on significant modifications:

```bash
# Compare with previous inventory
ansible-playbook playbooks/system/update-inventory.yaml \
  -e "compare_with_previous=true" \
  -e "alert_on_changes=true"
```

## Troubleshooting

### Authentication Issues
```bash
# Check Tailscale authentication status
tailscale status

# Re-authenticate if needed  
tailscale login

# Verify API key access
tailscale api /device | jq .
```

### Network Connectivity
```bash
# Test connectivity to Tailscale coordination server
ping coordination.tailscale.com

# Check local Tailscale daemon
systemctl status tailscaled
```

### Inventory Generation Issues
```bash
# Validate current inventory syntax
ansible-inventory --list --inventory inventories/tailscale.py

# Test inventory connectivity
ansible all -m ping --inventory inventories/tailscale.py
```

### Common Error Solutions

- **"Device not authenticated"**: Run `tailscale login` or check auth key
- **"Permission denied"**: Verify user has access to query network devices
- **"Network unreachable"**: Check Tailscale daemon status and connectivity
- **"Invalid inventory format"**: Review generated inventory file syntax

## Best Practices

1. **Backup existing inventory** before updates
2. **Test inventory connectivity** after updates
3. **Use filtering** to avoid including test or temporary devices
4. **Schedule regular updates** to maintain accuracy
5. **Monitor for significant changes** that might indicate issues
6. **Document custom grouping logic** for team understanding
7. **Maintain access controls** on Tailscale network

## Security Considerations

- Inventory data may contain sensitive network topology information
- Protect generated inventory files with appropriate permissions
- Use least-privilege access for Tailscale API queries
- Regularly rotate Tailscale API keys
- Monitor inventory access and modifications

## Notes

- The playbook is idempotent and safe to run repeatedly
- Large networks may take several minutes to process
- Offline devices are included by default but can be excluded
- Custom group logic can be extended via playbook variables
- Generated inventory is compatible with standard Ansible inventory format